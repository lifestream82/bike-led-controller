<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö¥ Bike LED BLE Controller</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }
        
        .header {
            text-align: center;
            padding: 40px 20px 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            margin: 0;
            font-size: 36px;
            font-weight: 300;
            letter-spacing: 2px;
        }
        
        .connection-status {
            margin-top: 10px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.8);
        }
        
        .connection-status.connected {
            background: rgba(76, 175, 80, 0.8);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }
        
        .toggle-container {
            text-align: center;
        }
        
        .connect-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .connect-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .connect-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .toggle-switch {
            position: relative;
            width: 140px;
            height: 280px;
            background: #333;
            border-radius: 70px;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.3),
                0 10px 30px rgba(0,0,0,0.3);
            margin: 0 auto 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
        }
        
        .toggle-switch.connected {
            opacity: 1;
        }
        
        .toggle-switch.on {
            background: linear-gradient(180deg, #4CAF50 0%, #45a049 100%);
        }
        
        .toggle-switch.off {
            background: linear-gradient(180deg, #666 0%, #333 100%);
        }
        
        .toggle-button {
            position: absolute;
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 60px;
            left: 10px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 
                0 10px 25px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }
        
        .toggle-switch.on .toggle-button {
            transform: translateY(150px);
            background: #4CAF50;
            color: white;
            box-shadow: 
                0 5px 15px rgba(76, 175, 80, 0.4),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .toggle-switch.off .toggle-button {
            transform: translateY(10px);
            background: #f44336;
            color: white;
            box-shadow: 
                0 5px 15px rgba(244, 67, 54, 0.4),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .status-text {
            font-size: 24px;
            font-weight: 300;
            margin-top: 20px;
            opacity: 0.9;
        }
        
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        
        .timer-info {
            display: flex;
            align-items: center;
            font-size: 16px;
        }
        
        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            margin-left: 10px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }
        
        .debug-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .debug-info {
            position: fixed;
            top: 120px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            max-width: 250px;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .toggle-switch:active {
            animation: pulse 0.2s ease;
        }
        
        .ble-support-warning {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 15px;
            margin: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üö¥ Bike LED</h1>
        <div id="connectionStatus" class="connection-status disconnected">
            üî¥ Ïó∞Í≤∞ ÏïàÎê®
        </div>
    </div>
    
    <div id="bleWarning" class="ble-support-warning">
        ‚ö†Ô∏è Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî Web BluetoothÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.<br>
        iOS 16.4+ Safari ÎòêÎäî ChromeÏùÑ ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.
    </div>
    
    <div class="main-content">
        <div class="toggle-container">
            <button id="connectButton" class="connect-button" onclick="connectToBLE()">
                üì° BLE Ïó∞Í≤∞
            </button>
            
            <div id="toggleSwitch" class="toggle-switch off" onclick="toggleLED()">
                <div class="toggle-button">OFF</div>
            </div>
            <div id="statusText" class="status-text">Ïó∞Í≤∞ ÌïÑÏöî</div>
        </div>
    </div>
    
    <div class="bottom-bar">
        <div class="timer-info">
            ‚è∞ <span id="countdown" class="timer-display">--:--</span>
        </div>
        <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
    </div>
    
    <div id="debugInfo" class="debug-info">
        ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ ÏóÜÏùå
    </div>

    <script>
        // BLE Í¥ÄÎ†® Î≥ÄÏàò
        let bleDevice = null;
        let bleServer = null;
        let ledCharacteristic = null;
        let statusCharacteristic = null;
        let isConnected = false;
        let debugVisible = false;
        
        // UUID ÏÑ§Ï†ï (ESP32ÏôÄ ÎèôÏùºÌï¥Ïïº Ìï®)
        const SERVICE_UUID = '12345678-1234-1234-1234-123456789abc';
        const LED_CHAR_UUID = '87654321-4321-4321-4321-abcdef123456';
        const STATUS_CHAR_UUID = '11111111-2222-3333-4444-555555555555';
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú BLE ÏßÄÏõê ÌôïÏù∏
        window.addEventListener('load', () => {
            if (!navigator.bluetooth) {
                document.getElementById('bleWarning').style.display = 'block';
                document.getElementById('connectButton').disabled = true;
            }
        });
        
        function toggleDebug() {
            debugVisible = !debugVisible;
            document.getElementById('debugInfo').className = debugVisible ? 'debug-info show' : 'debug-info';
        }
        
        async function connectToBLE() {
            if (isConnected) {
                disconnect();
                return;
            }
            
            try {
                updateDebug('üîç BLE Ïû•Ïπò Í≤ÄÏÉâ Ï§ë...');
                document.getElementById('connectButton').textContent = 'Ïó∞Í≤∞ Ï§ë...';
                document.getElementById('connectButton').disabled = true;
                
                // BLE Ïû•Ïπò ÏÑ†ÌÉù
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Bike LED Controller' }],
                    optionalServices: [SERVICE_UUID]
                });
                
                updateDebug('üîó BLE ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ï§ë...');
                
                // GATT ÏÑúÎ≤Ñ Ïó∞Í≤∞
                bleServer = await bleDevice.gatt.connect();
                
                // ÏÑúÎπÑÏä§ Í∞ÄÏ†∏Ïò§Í∏∞
                const service = await bleServer.getPrimaryService(SERVICE_UUID);
                
                // Ï∫êÎ¶≠ÌÑ∞Î¶¨Ïä§Ìã± Í∞ÄÏ†∏Ïò§Í∏∞
                ledCharacteristic = await service.getCharacteristic(LED_CHAR_UUID);
                statusCharacteristic = await service.getCharacteristic(STATUS_CHAR_UUID);
                
                // ÏÉÅÌÉú ÏïåÎ¶º Íµ¨ÎèÖ
                await statusCharacteristic.startNotifications();
                statusCharacteristic.addEventListener('characteristicvaluechanged', handleStatusUpdate);
                
                // Ïó∞Í≤∞ Ìï¥Ï†ú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                isConnected = true;
                updateConnectionStatus(true);
                updateDebug('‚úÖ BLE Ïó∞Í≤∞ ÏÑ±Í≥µ!');
                
                // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏöîÏ≤≠
                await sendCommand('s');
                
            } catch (error) {
                updateDebug('‚ùå BLE Ïó∞Í≤∞ Ïã§Ìå®: ' + error.message);
                console.error('BLE Ïó∞Í≤∞ Ïò§Î•ò:', error);
                
                document.getElementById('connectButton').textContent = 'üì° BLE Ïó∞Í≤∞';
                document.getElementById('connectButton').disabled = false;
            }
        }
        
        function disconnect() {
            if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
            }
        }
        
        function onDisconnected() {
            isConnected = false;
            updateConnectionStatus(false);
            updateDebug('üî¥ BLE Ïó∞Í≤∞ Ìï¥Ï†úÎê®');
            
            bleDevice = null;
            bleServer = null;
            ledCharacteristic = null;
            statusCharacteristic = null;
        }
        
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            const connectButton = document.getElementById('connectButton');
            const toggleSwitch = document.getElementById('toggleSwitch');
            
            if (connected) {
                statusDiv.textContent = 'üü¢ Ïó∞Í≤∞Îê®';
                statusDiv.className = 'connection-status connected';
                connectButton.textContent = 'üî¥ Ïó∞Í≤∞ Ìï¥Ï†ú';
                connectButton.disabled = false;
                toggleSwitch.classList.add('connected');
            } else {
                statusDiv.textContent = 'üî¥ Ïó∞Í≤∞ ÏïàÎê®';
                statusDiv.className = 'connection-status disconnected';
                connectButton.textContent = 'üì° BLE Ïó∞Í≤∞';
                connectButton.disabled = false;
                toggleSwitch.classList.remove('connected');
                
                document.getElementById('statusText').textContent = 'Ïó∞Í≤∞ ÌïÑÏöî';
                document.getElementById('countdown').textContent = '--:--';
            }
        }
        
        async function sendCommand(command) {
            if (!isConnected || !ledCharacteristic) {
                updateDebug('‚ùå BLE Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå');
                return;
            }
            
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(command);
                await ledCharacteristic.writeValue(data);
                updateDebug('üì§ Î™ÖÎ†π Ï†ÑÏÜ°: ' + command);
            } catch (error) {
                updateDebug('‚ùå Î™ÖÎ†π Ï†ÑÏÜ° Ïã§Ìå®: ' + error.message);
                console.error('Î™ÖÎ†π Ï†ÑÏÜ° Ïò§Î•ò:', error);
            }
        }
        
        async function toggleLED() {
            if (!isConnected) {
                alert('Î®ºÏ†Ä BLEÏóê Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            // Ï¶âÏãú UI Î∞òÏùë
            const toggleSwitch = document.getElementById('toggleSwitch');
            toggleSwitch.style.transform = 'scale(0.95)';
            setTimeout(() => {
                toggleSwitch.style.transform = 'scale(1)';
            }, 150);
            
            await sendCommand('t'); // ÌÜ†Í∏Ä Î™ÖÎ†π
        }
        
        function handleStatusUpdate(event) {
            const decoder = new TextDecoder();
            const statusStr = decoder.decode(event.target.value);
            
            try {
                const status = JSON.parse(statusStr);
                updateUI(status);
                updateDebug('üì• ÏÉÅÌÉú ÏàòÏã†: ' + statusStr);
            } catch (error) {
                updateDebug('‚ùå ÏÉÅÌÉú ÌååÏã± Ïò§Î•ò: ' + error.message);
            }
        }
        
        function updateUI(status) {
            const toggleSwitch = document.getElementById('toggleSwitch');
            const toggleButton = toggleSwitch.querySelector('.toggle-button');
            const statusText = document.getElementById('statusText');
            const countdownElement = document.getElementById('countdown');
            
            if (status.sleeping) {
                statusText.textContent = 'üò¥ Ï†àÏ†Ñ Î™®Îìú';
                countdownElement.textContent = 'Ï†àÏ†ÑÏ§ë';
                return;
            }
            
            if (status.led) {
                // LED ÏºúÏßê ÏÉÅÌÉú
                toggleSwitch.className = 'toggle-switch on connected';
                toggleButton.textContent = 'ON';
                statusText.textContent = 'üîÜ LED ÏºúÏßê';
                countdownElement.textContent = 'Ìï≠ÏÉÅ ÏºúÏßê';
                countdownElement.style.color = '#4CAF50';
            } else {
                // LED Í∫ºÏßê ÏÉÅÌÉú
                toggleSwitch.className = 'toggle-switch off connected';
                toggleButton.textContent = 'OFF';
                statusText.textContent = 'üîÖ LED Í∫ºÏßê';
                
                const remaining = parseInt(status.timeUntilSleep) || 0;
                
                if (remaining > 0) {
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    countdownElement.textContent = 
                        minutes.toString().padStart(2, '0') + ':' + 
                        seconds.toString().padStart(2, '0');
                    countdownElement.style.color = remaining <= 5 * 60 ? '#ff6b6b' : '#fff';
                } else {
                    countdownElement.textContent = 'Í≥ß Ï†àÏ†Ñ';
                    countdownElement.style.color = '#ff6b6b';
                }
            }
        }
        
        function updateDebug(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML = `
                <strong>üïê ${timestamp}</strong><br>
                ${message}<br>
                <hr style="margin: 10px 0; opacity: 0.3;">
                ${debugDiv.innerHTML}
            `.substring(0, 1000); // Î°úÍ∑∏ Í∏∏Ïù¥ Ï†úÌïú
        }
        
        // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
        document.addEventListener('keydown', (event) => {
            if (!isConnected) return;
            
            switch(event.key.toLowerCase()) {
                case ' ': // Ïä§ÌéòÏù¥Ïä§Î∞î
                case 't':
                    event.preventDefault();
                    toggleLED();
                    break;
                case '1':
                    event.preventDefault();
                    sendCommand('1');
                    break;
                case '0':
                    event.preventDefault();
                    sendCommand('0');
                    break;
                case 's':
                    event.preventDefault();
                    sendCommand('s');
                    break;
            }
        });
        
        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ïó∞Í≤∞ Ìï¥Ï†ú
        window.addEventListener('beforeunload', () => {
            if (isConnected) {
                disconnect();
            }
        });
        
        // ÌéòÏù¥ÏßÄ Ïà®ÍπÄ/ÌëúÏãú Ïãú ÏûêÎèô Ïû¨Ïó∞Í≤∞ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && bleDevice && !bleDevice.gatt.connected) {
                updateDebug('üì± ÌéòÏù¥ÏßÄ ÌôúÏÑ±Ìôî - Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ');
                setTimeout(() => {
                    if (!isConnected) {
                        connectToBLE();
                    }
                }, 1000);
            }
        });
        
        // PWA ÏÑ§Ïπò Í¥ÄÎ†® (ÏÑ†ÌÉùÏÇ¨Ìï≠)
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ÏÑ§Ïπò Î≤ÑÌäº ÌëúÏãú (ÏõêÌïúÎã§Î©¥)
            const installButton = document.createElement('button');
            installButton.textContent = 'üì± Ïï± ÏÑ§Ïπò';
            installButton.className = 'debug-toggle';
            installButton.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                    installButton.remove();
                });
            };
            
            document.querySelector('.bottom-bar').appendChild(installButton);
        });
        
    </script>
</body>
</html>
